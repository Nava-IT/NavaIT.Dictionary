parameters:
  - name: 'buildConfiguration'
    displayName: 'Build Configuration'
    type: string
    values:
      - Release
      - Debug
  - name: 'projectName'
    displayName: 'Project Name'
    type: string
  - name: 'artifact'
    displayName: 'Artifact Name'
    type: string
  - name: 'appType'
    displayName: 'Application Type'
    type: string
  - name: 'portNumber'
    type: string

jobs:
  - deployment: 'Deploy${{replace(parameters.projectName, ''.'', ''_'')}}'
    displayName: 'Deploy ${{parameters.projectName}}'
    environment: $(deployEnviroment)
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo $(System.ArtifactsDirectory)
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              artifactName: ${{parameters.artifact}}
              downloadPath: '$(System.ArtifactsDirectory)'
          - task: IISWebAppManagementOnMachineGroup@0
            displayName: 'IIS Web App Manage'
            inputs:
              EnableIIS: true
              IISDeploymentType: 'IISWebsite'
              ActionIISWebsite: 'CreateOrUpdateWebsite'
              WebsiteName: 'Sandbox${{parameters.appType}}'
              WebsitePhysicalPath: '%SystemDrive%\sandbox\${{parameters.appType}}'
              WebsitePhysicalPathAuth: 'WebsiteUserPassThrough'
              AddBinding: true
              Bindings: '{"bindings":[{"protocol":"http","ipAddress":"All Unassigned","port":"${{parameters.portNumber}}","hostname":"","sslThumbprint":"","sniFlag":false}]}'
              CreateOrUpdateAppPoolForWebsite: true
              AppPoolNameForWebsite: 'Sandbox${{parameters.appType}}'
              DotNetVersionForWebsite: 'No Managed Code'
              PipeLineModeForWebsite: 'Integrated'
              AppPoolName: 'Sandbox${{parameters.appType}}'
              AppPoolIdentityForWebsite: 'SpecificUser'
              AppPoolUsernameForWebsite: '$(iisUsername)'
              AppPoolPasswordForWebsite: '$(iisUserPassword)'
          - task: IISWebAppManagementOnMachineGroup@0
            inputs:
              EnableIIS: true
              IISDeploymentType: 'IISWebApplication'
              ParentWebsiteNameForApplication: 'Sandbox${{parameters.appType}}'
              VirtualPathForApplication: '/$(Build.SourceBranch)'
              PhysicalPathForApplication: '%SystemDrive%\sandbox\${{parameters.appType}}\$(Build.SourceBranch)'
              ApplicationPhysicalPathAuth: 'ApplicationWindowsAuth'
              ApplicationAuthUserName: '$(iisUser)'
              ApplicationAuthUserPassword: '$(iisPassword)'
              CreateOrUpdateAppPoolForApplication: true
              AppPoolNameForApplication: 'DevOpsAndGithubIntegration_${{replace(Build.SourceBranch, ''/'', ''_'')}}'
              DotNetVersionForApplication: 'No Managed Code'
              PipeLineModeForApplication: 'Integrated'
              AppPoolIdentityForApplication: 'SpecificUser'
              AppPoolUsernameForApplication: '$(iisUser)'
              AppPoolPasswordForApplication: '$(iisPassword)'
          - script: 'echo $(System.ArtifactsDirectory)\**\${{parameters.projectName}}.zip'
          - task: IISWebAppDeploymentOnMachineGroup@0
            displayName: 'IIS Web App Deploy'
            inputs:
              WebSiteName: 'Sandbox${{parameters.appType}}'
              VirtualApplication: '/$(Build.SourceBranch)'
              Package: '$(System.ArtifactsDirectory)\**\${{parameters.projectName}}.zip'
              RemoveAdditionalFilesFlag: true
              TakeAppOfflineFlag: true
              XmlVariableSubstitution: true
